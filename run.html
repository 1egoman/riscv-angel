<html>
<head> 

<!-- load js libraries required for angel core ops -->
<script src="lib/goog/base.js"></script>
<script>
goog.require("goog.math.Long");
</script>

<!-- map to Long for convenience -->
<script>
Long = goog.math.Long;
</script>

<!-- load angel -->
<script src="utils.js"></script>
<script src="elfload.js"></script>
<script src="inst.js"></script>
<script src="cpu.js"></script>
<script src="assemble.js"></script>
<script src="mappings.js"></script>

<!-- bootstrap -->
<link href="style/css/bootstrap.min.css" rel="stylesheet">
<script src="style/jquery/jquery.min.js"></script>
<script src="style/js/bootstrap.min.js"></script>

<style type="text/css">
    body { 
        padding-top: 20px;
        padding-bottom: 40px;
    }

    .container-narrow {
        margin: 0 auto;
        max-width: 960px;
    }

    #userCode {
        font-family: Monaco, Consolas, Lucida Console, monospace;
    }
</style>

<!-- angel functions -->
<script>

// handles "Type Assembly" tab
function runCode(userIn) {
    tab = document.getElementById("regtable");

    userIn = assemble(userIn);

    RISCV = new CPU();

    // load program into memory
    RISCV.load_to_mem([[0, 0], userIn]);

    RISCV.reset_wall_clock();

    // run
    var instVal = RISCV.load_word_from_mem(RISCV.pc);
    while(instVal != 0){
        // run instruction
        var inst = new instruction(instVal);
        runInstruction(inst, RISCV);

        // update output (this doesn't actually update every cycle, need 
        // to find a better way
        // for (var i = 0; i < RISCV.gen_reg.length; i++){
        //    tab.rows[i+1].cells[1].innerHTML = (RISCV.gen_reg[i]|0).toString();
        //}

        // load next instruction
        instVal = RISCV.load_word_from_mem(RISCV.pc);
    }

    // update output
    update_html_regtable(RISCV, tab);

}

// handles "Run from File" tab
function handle_file(file){
    tab = document.getElementById("regtable");
    elfproptab = document.getElementById("elfprops");

    file = file.target.files[0];
    var reader = new FileReader();
    RISCV = new CPU();

    reader.onload = (function(theFile) {
        return function(e) {
            loadElf(e.target.result);
        };
    })(file);

    reader.readAsBinaryString(file);
}
</script>
</head>

<body>
<div class="container-narrow">
    <div class="masthead" align="center">
        <h3><a href="#" data-toggle="tooltip" data-placement="bottom" title="ANGEL is Naturally Good at Executing Linux">ANGEL</a> - Browser-based RISC-V ISA simulator</h3>
    </div>

    <div class="row-fluid marketing">
        <div class="span5">

            <div class="tabbable">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#tab1" data-toggle="tab">Type Assembly</a></li>
                    <li><a href="#tab2" data-toggle="tab">Run from File</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        Your code here:
                        <textarea id="userCode" class="row-fluid" rows="20">
Sample: addi s0, s0, -1
sw s0, -4(sp)
lw s1, -4(sp)
lh s2, -4(sp)
lb s3, -4(sp)
lhu s4, -4(sp)
lbu s5, -4(sp)
sb zero, -4(sp)
sb zero, -3(sp)
lw s6, -4(sp)
sh s0, -8(sp)
lh s7, -8(sp)
jal AddOne
j End
AddOne: addi s8, s8, 1
jalr.r zero, ra, 0
End: addi s9, s9, 200</textarea>
                        <br>
                        <a class="btn btn-large btn-success" onclick="runCode(document.getElementById('userCode').value)">Run</a> <br>
                    </div>
                    <div class="tab-pane" id="tab2">
                        <input type="file" id="files" name="files[]" multiple />

                        <table id="elfprops" class="table table-striped table-hover table-condensed table-bordered">
                            <tr>
                                <td>ELF Property</td>
                                <td>Value</td>
                            </tr>
                            <tr>
                                <td>No ELF selected</td>
                                <td></td>
                            </tr>
                        </table>
                        <div id="testrestext">Test Result (for RV64 tests): </div>
                        <div id="testresult">ELF not loaded</div>
                    </div>
                </div>
            </div>

        </div>
        <div class="span7">
            Output:
            <table id="regtable" class="table table-striped table-hover table-condensed table-bordered">
                <tr>
                    <td>Register</td>
                    <td>Value (Hex)</td>
                    <td>Value (Unsigned Dec.)</td>
                </tr>
                <tr>
                    <td>x0 (zero)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x1 (ra)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x2 (s0)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x3 (s1)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x4 (s2)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x5 (s3)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x6 (s4)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x7 (s5)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x8 (s6)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x9 (s7)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x10 (s8)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x11 (s9)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x12 (s10)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x13 (s11)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x14 (sp)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x15 (tp)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x16 (v0)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x17 (v1)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x18 (a0)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x19 (a1)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x20 (a2)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x21 (a3)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x22 (a4)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x23 (a5)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x24 (a6)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x25 (a7)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x26 (a8)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x27 (a9)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x28 (a10)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x29 (a11)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x30 (a12)</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>x31 (a13)</td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="footer">
        Based on <a href="http://inst.eecs.berkeley.edu/~cs152/sp12/handouts/riscv-spec.pdf">The RISC-V Instruction Set Manual</a> <br>
        Source on <a href="https://github.com/sagark/angel">Github</a>
        <!-- nothing here for now -->

    </div>

</div>
</body>

<!-- misc end-of-page scripts -->
<script>
    // enable bootstrap tooltips
    $('a').tooltip();

    // init junk cpu to fill table
    runCode("addi zero, zero, 0");

    // file handler for "Run from file"
    document.getElementById("files").addEventListener('change', handle_file, false);
</script>

</html>
